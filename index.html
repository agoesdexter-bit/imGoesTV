<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPTV Player</title>
</head>
<body>
  <h1>My IPTV Player</h1>
  <video id="videoPlayer" controls autoplay style="width:100%; max-width:800px;"></video>
  <ul id="channelList"></ul>

  <script>
    const videoPlayer = document.getElementById('videoPlayer');
    const channelList = document.getElementById('channelList');

    // Playlist URL through proxy
    const playlistUrl = '/api/proxy?url=' + encodeURIComponent(
      'https://raw.githubusercontent.com/mgi24/tvdigital/main/idwork.m3u'
    );

    async function loadPlaylist() {
      try {
        const response = await fetch(playlistUrl);
        const playlistText = await response.text();

        const channels = parseM3U(playlistText);

        channels.forEach(channel => {
          const li = document.createElement('li');
          li.textContent = channel.name;
          li.style.cursor = 'pointer';
          li.onclick = () => {
            videoPlayer.src = '/api/proxy?url=' + encodeURIComponent(channel.url);
            videoPlayer.play();
          };
          channelList.appendChild(li);
        });

        // Auto-play first channel
        if (channels.length > 0) {
          videoPlayer.src = '/api/proxy?url=' + encodeURIComponent(channels[0].url);
          videoPlayer.play();
        }
      } catch (err) {
        console.error('Failed to load playlist:', err);
      }
    }

    function parseM3U(data) {
      const lines = data.split('\n');
      const channels = [];
      let currentName = '';

      lines.forEach(line => {
        if (line.startsWith('#EXTINF:')) {
          const nameMatch = line.match(/,(.*)$/);
          currentName = nameMatch ? nameMatch[1].trim() : 'Unknown';
        } else if (line.startsWith('http')) {
          channels.push({ name: currentName, url: line.trim() });
        }
      });

      return channels;
    }

    loadPlaylist();
  </script>
</body>
</html>
